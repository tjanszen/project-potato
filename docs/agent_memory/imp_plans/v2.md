# Implementation Plan v2 - Potato Runs & Totals Tracking

## Overview
Phase-gated development plan for adding runs and totals tracking to the habit tracking web app. Users can now see their total "No Drink" days and track consecutive day streaks (runs). All features ship behind feature flag `ff.potato.runs_v2` (default OFF).

**Dependencies:** Requires v1 foundation (authentication, day marking, calendar interface) to be fully operational.

---

## PHASE 0: Spike & Research - Rules Definition & Data Model Validation
- **Goal:** Research and define business rules for runs calculation, validate data model tradeoffs, and establish calculation algorithms before database changes
- **Tasks:**
  - Define run calculation rules (consecutive days, timezone boundaries, gap handling)
  - Research data model options: users table columns vs dedicated runs table
  - Create test scenarios for run calculation edge cases (month boundaries, leap years, gaps)
  - Validate run merging logic (when filling gaps creates longer runs)
  - Design run calculation algorithm with performance considerations
  - Document run lifecycle: start, extend, end, merge scenarios
  - Create sample test data for validation
- **Risks/Assumptions:**
  - Run calculation rules may be complex with timezone edge cases
  - Performance impact of run calculation on day marking operations
  - Data model choice affects future scalability and query performance
- **Exit Criteria (objective, testable):**
  - Run calculation rules documented with clear edge case handling
  - Data model decision made with performance/complexity tradeoffs analyzed
  - Test scenarios cover all run lifecycle operations
  - Algorithm handles timezone-aware consecutive day detection
  - Performance benchmarks established for calculation overhead
- **Evidence to Collect:**
  ```bash
  # Document test scenarios
  echo "Test Case 1: Single day -> 1 day run"
  echo "Test Case 2: 3 consecutive days -> 3 day run" 
  echo "Test Case 3: Fill 1-day gap -> merge two runs"
  echo "Test Case 4: Cross month boundary -> maintain run"
  echo "Test Case 5: Timezone edge case -> proper day detection"
  ```
  - Run calculation algorithm pseudocode documented
  - Data model comparison matrix (performance, complexity, storage)
  - Edge case test results with expected vs actual outcomes
- **Rollback Plan:** No database changes in this phase - documentation only
- **Feature Flag(s):** ff.potato.runs_v2 + default OFF + research phase

---

## PHASE 6A: Database Foundations - Runs Table & Schema
- **Goal:** Create runs table schema and establish uniqueness constraints for reliable run tracking
- **Tasks:**
  - Create runs table with user_id, start_date, end_date, day_count columns
  - Add unique constraint on day_marks (user_id, date) if not already present
  - Implement database indexes for efficient run queries
  - Create database migration script for runs table
  - Add foreign key relationships (runs -> users)
  - Update shared/schema.ts with runs model and relations
- **Risks/Assumptions:**
  - Database migration succeeds without affecting existing day_marks data
  - Unique constraints prevent duplicate day_marks that would break run calculations
  - Index performance adequate for run lookup queries
- **Exit Criteria (objective, testable):**
  - Runs table created with correct schema and constraints
  - Unique constraint enforced on day_marks (user_id, date)
  - Foreign key relationships established and enforced
  - Database indexes improve run query performance
  - No data loss or corruption during migration
- **Evidence to Collect:**
  ```sql
  SELECT table_name FROM information_schema.tables WHERE table_name = 'runs';
  SELECT column_name, data_type, is_nullable FROM information_schema.columns WHERE table_name = 'runs';
  SELECT constraint_name, constraint_type FROM information_schema.table_constraints WHERE table_name = 'day_marks';
  ```
  ```bash
  npm run db:push
  # Verify no errors during schema push
  ```
- **Rollback Plan:** Drop runs table, remove foreign key constraints if needed
- **Feature Flag(s):** ff.potato.runs_v2 + default OFF + database schema gated

---

## PHASE 6B: Inline Run Calculation - Real-time Run Updates
- **Goal:** Implement automatic run calculation and updates when day_marks are created, maintaining real-time accuracy
- **Tasks:**
  - Create run calculation service with start/extend/merge/end logic
  - Integrate run updates into day marking API (POST /api/days/:date/no-drink)
  - Handle run creation for first day marked
  - Implement run extension for consecutive days
  - Add run merging logic when filling gaps between existing runs
  - Create run splitting logic for future "unmark" functionality
  - Add transaction handling to ensure day_marks and runs stay consistent
  - Implement timezone-aware consecutive day detection
- **Risks/Assumptions:**
  - Run calculation adds latency to day marking operations
  - Complex run merging logic has edge cases that break consistency
  - Transaction handling prevents partial updates during failures
  - Timezone calculations work correctly across different user timezones
- **Exit Criteria (objective, testable):**
  - Single day marking creates 1-day run
  - Consecutive day marking extends existing run
  - Gap filling merges separate runs into single longer run
  - All run operations are transactional (no partial updates)
  - Run calculations respect user timezone for consecutive day detection
- **Evidence to Collect:**
  ```bash
  # Test single day run creation
  curl -X POST -b cookies.txt http://localhost:3000/api/days/2025-06-15/no-drink
  ```
  ```sql
  SELECT user_id, start_date, end_date, day_count FROM runs WHERE user_id = 'test-user-id';
  SELECT COUNT(*) FROM day_marks WHERE user_id = 'test-user-id';
  ```
  ```bash
  # Test consecutive day extension
  curl -X POST -b cookies.txt http://localhost:3000/api/days/2025-06-16/no-drink
  ```
  ```sql
  SELECT user_id, start_date, end_date, day_count FROM runs WHERE user_id = 'test-user-id';
  # Should show 2-day run from 2025-06-15 to 2025-06-16
  ```
- **Rollback Plan:** Disable run calculation in day marking API, preserve day_marks functionality
- **Feature Flag(s):** ff.potato.runs_v2 + default OFF + run calculation gated

---

## PHASE 6C: API Endpoints - Runs & Totals Data Access
- **Goal:** Create API endpoints to expose user runs and totals data for frontend consumption
- **Tasks:**
  - Create GET /api/runs endpoint for user's run history
  - Create GET /api/stats endpoint for user totals (total days, current run, longest run)
  - Add pagination support for run history endpoint
  - Implement date range filtering for run queries
  - Add authentication middleware to protect runs endpoints
  - Create runs data validation and error handling
  - Add runs data to existing user profile endpoint (GET /api/me)
- **Risks/Assumptions:**
  - API response times acceptable with large numbers of runs
  - Pagination implementation handles edge cases correctly
  - Authentication middleware correctly protects runs data access
- **Exit Criteria (objective, testable):**
  - GET /api/runs returns authenticated user's run history
  - GET /api/stats returns correct totals (total days, current run, longest run)
  - Pagination works correctly with large datasets
  - Unauthenticated requests return 401 errors
  - API responses match expected data format
- **Evidence to Collect:**
  ```bash
  curl -b cookies.txt http://localhost:3000/api/runs
  # Should return JSON array of user's runs
  curl -b cookies.txt http://localhost:3000/api/stats
  # Should return: {"totalDays": 5, "currentRun": 3, "longestRun": 4}
  curl http://localhost:3000/api/runs
  # Should return 401 without authentication
  ```
  ```sql
  SELECT COUNT(*) AS total_runs FROM runs WHERE user_id = 'test-user-id';
  SELECT SUM(day_count) AS total_days FROM runs WHERE user_id = 'test-user-id';
  ```
- **Rollback Plan:** Disable runs endpoints, remove from routing
- **Feature Flag(s):** ff.potato.runs_v2 + default OFF + API endpoints gated

---

## PHASE 6D: Dashboard Integration - UI Runs & Totals Display
- **Goal:** Integrate runs and totals display into the existing calendar dashboard interface
- **Tasks:**
  - Add runs statistics component to dashboard header/sidebar
  - Display total days marked, current run length, longest run achieved
  - Create visual indicators for active runs in calendar interface
  - Add loading states for runs data fetching
  - Implement error handling for runs API failures
  - Add runs data to React Query cache management
  - Create responsive design for runs statistics display
  - Add optional celebrations/badges for milestone runs
- **Risks/Assumptions:**
  - UI performance acceptable with additional API calls for runs data
  - Visual design integrates well with existing calendar interface
  - React Query caching prevents excessive API requests
- **Exit Criteria (objective, testable):**
  - Dashboard displays correct runs statistics on page load
  - Statistics update immediately after day marking
  - Visual indicators show active runs in calendar
  - Loading states appear during data fetching
  - Error states display user-friendly messages
- **Evidence to Collect:**
  ```bash
  # Browser testing required - no curl equivalent
  # Navigate to dashboard, verify stats display
  # Mark new day, verify stats update immediately
  # Check network tab for efficient API usage
  ```
  - Manual testing: verify statistics accuracy and real-time updates
  - Performance testing: measure dashboard load time with runs data
  - Visual inspection: responsive design on mobile and desktop
- **Rollback Plan:** Hide runs statistics display, remove from dashboard components
- **Feature Flag(s):** ff.potato.runs_v2 + default OFF + dashboard display gated

---

## PHASE 6E: Run History & Longest Run Enhancement
- **Goal:** Add comprehensive run history view and longest run achievements tracking
- **Tasks:**
  - Create dedicated runs history page/view
  - Add run detail information (start date, end date, day count)
  - Implement longest run highlighting and celebration
  - Create run timeline visualization
  - Add run sharing functionality (optional)
  - Implement run comparison features (current vs longest, monthly trends)
  - Add export functionality for run data
  - Create run achievement badges/milestones
- **Risks/Assumptions:**
  - Additional UI complexity doesn't impact core day marking workflow
  - Run timeline visualization performs well with large datasets
  - Achievement system motivates users without becoming overwhelming
- **Exit Criteria (objective, testable):**
  - Run history page displays complete user run timeline
  - Longest run is highlighted and celebrated
  - Run timeline visualization renders correctly
  - Achievement badges appear for milestone runs
  - Export functionality produces correct run data
- **Evidence to Collect:**
  ```bash
  # Browser testing required
  # Navigate to run history, verify complete timeline
  # Check longest run highlighting
  # Test export functionality
  ```
  - Manual testing: verify run history accuracy and completeness
  - Performance testing: timeline visualization with 100+ runs
  - User experience testing: achievement system effectiveness
- **Rollback Plan:** Disable run history features, revert to basic stats display
- **Feature Flag(s):** ff.potato.runs_v2 + default OFF + history features gated

---

## PHASE 6F: Performance Optimization & Production Readiness
- **Goal:** Optimize run calculation performance and prepare runs feature for production deployment
- **Tasks:**
  - Optimize database queries for run calculations and lookups
  - Add database indexes for efficient run queries
  - Implement run calculation caching strategies
  - Add run calculation performance monitoring
  - Create run data migration scripts for existing users
  - Add run calculation stress testing
  - Implement run data backup and recovery procedures
  - Document run calculation algorithms and maintenance procedures
- **Risks/Assumptions:**
  - Performance optimizations don't introduce calculation bugs
  - Database migrations complete successfully for all existing users
  - Caching strategies maintain data consistency
- **Exit Criteria (objective, testable):**
  - Run calculations complete within 100ms for typical users
  - Database indexes improve query performance by >50%
  - Existing user data migrated correctly with accurate run calculations
  - Stress testing handles 1000+ concurrent day marking operations
  - Monitoring alerts detect run calculation anomalies
- **Evidence to Collect:**
  ```bash
  # Performance testing
  time curl -X POST -b cookies.txt http://localhost:3000/api/days/2025-06-20/no-drink
  # Should complete in <100ms
  ```
  ```sql
  EXPLAIN ANALYZE SELECT * FROM runs WHERE user_id = 'test-user-id' ORDER BY start_date DESC;
  # Verify index usage and query performance
  ```
  - Load testing results for concurrent day marking
  - Database migration verification for existing users
  - Performance monitoring dashboard showing run calculation metrics
- **Rollback Plan:** Disable performance optimizations, revert to basic implementation
- **Feature Flag(s):** ff.potato.runs_v2 + default OFF + performance optimizations gated

---

## Feature Flag Activation Strategy

### Development Testing
1. Enable `ff.potato.runs_v2=true` in development environment
2. Test all phases incrementally with feature flag controls
3. Validate run calculations with diverse test data

### Production Rollout
1. Deploy with `ff.potato.runs_v2=false` (default OFF)
2. Enable for internal testing accounts first
3. Monitor performance and run calculation accuracy
4. Gradual rollout to user segments
5. Full activation after validation

### Rollback Procedures
- Feature flag can disable all runs functionality instantly
- Database changes are additive (runs table can remain unused)
- Day marking functionality remains fully operational regardless of runs feature state

---

## Success Metrics
- **Functionality:** 100% accurate run calculations across all test scenarios
- **Performance:** Run calculations add <50ms latency to day marking
- **User Experience:** Runs statistics motivate continued habit tracking
- **Reliability:** Zero data inconsistencies between day_marks and runs tables
- **Production Readiness:** Feature flag enables safe rollout and quick rollback