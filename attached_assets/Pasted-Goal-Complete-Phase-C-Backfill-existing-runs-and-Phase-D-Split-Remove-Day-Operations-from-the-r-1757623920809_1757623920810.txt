Goal: Complete Phase C (Backfill existing runs) and Phase D (Split/Remove-Day Operations) from the runs calculation plan.

Do:
Phase C — Backfill Existing Runs
- Port rebuildUserRuns(userId) and rebuildAllUserRuns() from server/storage.ts into server/storage.js.
- Implement rebuildUserRuns(userId):
  • Delete existing runs for the user
  • Recalculate runs from all day_marks for that user
  • Insert fresh runs into runs table
- Implement rebuildAllUserRuns():
  • Iterate over all users with day_marks
  • Run rebuildUserRuns for each
- Ensure operations are idempotent and resilient (errors for one user don’t block others).

Phase D — Split/Remove-Day Operations
- Port performRunSplit (remove-day logic) from storage.ts to storage.js.
- Update day marking flow to handle unmarking (value=false) by:
  • Detecting if a marked day is removed
  • Adjusting run: shorten run if edge day removed, split run if middle day removed
  • Maintain day count accuracy
- Ensure split operation is idempotent: unmarking the same day twice = no change
- Validate no overlapping runs exist post-split.

Exit Criteria:
- Rebuild logic:
  • Running rebuildUserRuns(userId) populates runs table from day_marks.
  • Running rebuildAllUserRuns() processes all users.
  • Repeated rebuild yields same results (idempotent).
- Split/remove logic:
  • Unmarking start/end of a run shortens it correctly.
  • Unmarking middle of a run splits it into two valid runs.
  • No overlaps in runs after split.
  • Idempotent: unmarking the same day twice = no-op.
- /api/v2/totals reflects rebuilt and split data correctly.

Proof:
- Backfill:
  • SELECT COUNT(*) FROM runs WHERE user_id='a4f5419e-a020-4031-aa18-4b128e20f5c1'; → >0 after rebuild
  • curl http://localhost:$PORT/api/v2/totals?user_id=a4f5419e-a020-4031-aa18-4b128e20f5c1 → totals reflect historical marks
- Split/remove:
  • Mark days 2025-09-01 to 2025-09-05
  • Unmark 2025-09-05 → run shrinks to 4 days
  • Unmark 2025-09-03 → run splits into two runs [2025-09-01–2025-09-02] and [2025-09-04–2025-09-05]
  • SQL check: no overlaps, correct spans and day_counts

Rollback Plan:
- Remove or comment out split/unmark logic in markDay if errors arise.
- Use rebuildUserRuns() to restore runs table from day_marks at any time.
